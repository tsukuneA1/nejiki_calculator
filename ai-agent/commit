#!/bin/bash

set -e

# シンボリックリンクの実体を解決
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/ai.sh"

# オプション解析
SKIP_CONFIRM=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -y|--yes)
            SKIP_CONFIRM=true
            shift
            ;;
        -h|--help)
            cat << EOF
Usage: commit [OPTIONS]

AI Agentがコミットメッセージを生成してコミットします

OPTIONS:
    -y, --yes    確認をスキップして自動でコミット
    -h, --help   ヘルプを表示

EXAMPLES:
    commit           # 対話的にコミット
    commit -y        # 確認なしで自動コミット
EOF
            exit 0
            ;;
        *)
            log_error "不明なオプション: $1"
            exit 1
            ;;
    esac
done

# 変更があるかチェック (ステージングされていない変更や未追跡ファイルも含む)
if [[ -z "$(git status --porcelain 2>/dev/null)" ]]; then
    log_warn "コミットする変更がありません"
    exit 0
fi

# git statusとgit diffを表示
log_info "変更内容:"
git status --short
echo

# AI Agentにコミットメッセージを生成させる
log_info "コミットメッセージを生成中..."

STATUS_OUTPUT=$(git status --porcelain)
CACHED_DIFF=$(git diff --cached)
WORKING_DIFF=$(git diff)

prompt="以下のgit statusおよびgit diffに基づいて、適切なコミットメッセージを生成してください。

[git status --porcelain]
$STATUS_OUTPUT

[git diff --cached]
$CACHED_DIFF

[git diff]
$WORKING_DIFF

重要な指示:
- コミットメッセージのみを出力してください
- 余計な説明、前置き、コードブロック記法は一切不要です
- 1行目: 変更内容の要約（50文字以内）
- 2行目: 空行
- 3行目以降: 詳細な説明（必要に応じて）

コミットメッセージ以外の文章は絶対に出力しないでください。"

COMMIT_MSG=$(run_ai_agent "$prompt")

if [[ -z "$COMMIT_MSG" ]]; then
    log_error "コミットメッセージの生成に失敗しました"
    exit 1
fi

# コミットメッセージを表示
echo
log_info "生成されたコミットメッセージ:"
echo "---"
echo "$COMMIT_MSG"
echo "---"
echo

# 確認
if [[ "$SKIP_CONFIRM" == false ]]; then
    read -p "このメッセージでコミットしますか? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_warn "コミットをキャンセルしました"
        exit 0
    fi
fi

# コミット実行
git add -A
git commit -m "$COMMIT_MSG"
log_success "コミット完了"
